# Hướng dẫn sử dụng bộ công cụ testing rule

## Công cụ testing rule cho Content Analyst quick_test
### Tổng quan và cách sử dụng
- [Quick_test](./quick_test.py) là công cụ giúp Content Analyst phát hiện ra các lỗi có ngay trong quá trình xây dựng rule Offline EDR/SIEM.
- Cách sử dụng:
```sh 
usage: quick_test.py [-h] [-c CONFIG] [-f FILE] [-t TESTCASE]
Testing rule EDR/SIEM by check list
options:
  -h, --help            show this help message and exit
  -c CONFIG, --config CONFIG
                        config filepath
  -f FILE, --file FILE  folder or rule file
  -t TESTCASE, --testcase TESTCASE
                        json test file
```
- Đầu vào của **-c** là đường dẫn của file config. File config là một file **JSON** chứa các thông tin cần thiết. Ví dụ về một file config:
```json
{
    "vcs_ajiant" : {
        "_comment": "Thông tin về EDR",
        "username" : "user_edr",
        "password" : "pass_edr",
        "server" : "https://10.255.251.153"
    },
    "vcs_cym" : {
        "_comment": "Thông tin về SIEM",
        "username" : "user_siem",
        "password" : "pass_siem",
        "server" : "https://siem.staging.vcs.vn"
    },
    "Seatable" : {
        "_comment": "access token của SeaTable Red-Blue Work Format Sprint",
        "access_token" : "red_blue_token"
    },
}
```
- Đầu vào của **-f** là đường dẫn của file hoặc folder chứa file rule. Định dạng file rule là file **YAML** (yml/yaml). Ví dụ về một file rule:
```yml
rule_name: Process Creation Disable Hypervisor Enforced Code Integrity Via Regedit
id: 657035dd1e4e9df3e06c2392
description: Hypervisor-Enforced Code Integrity (HVCI) by setting the registry key
author: anhddq
tags:
- VCS_Content_Offline
- Sprint_27
date: 2023/10/12
modified: 2023/12/06
product: VCS_CyM
status: test
mitre-attack:
  technique:
  - T1562.001
  tactic: 
  - Defense Evasion
  datasource: 
  - command.command_exection
  - process.process_creation
reference:
- https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1562.001/T1562.001.md#atomic-test-43---disable-hypervisor-enforced-code-integrity-hvci
filter:
  event:
    logsource:
      category|feature: process_creation
    query:
    - AND:
      - target_commandline.replaceAll("(\"| +)", "").toLowerCase()|assign|raw: $tcl
      - target_process_path.toLowerCase()|endswith: \reg.exe
      - $tcl|contains: add
      - $tcl|contains: \deviceguard\scenarios\hypervisorenforcedcodeintegrity
      - $tcl|contains: /venabled
      - $tcl|contains: /d0
indicator:
  not_alert:
    query:
    - client_id|==|raw: $event.getClient_id()
    time_window: 1h
  accumulate:
    query:
    - client_id|==|raw: $event.getClient_id()
    time_window: 1h
    count|>=: 1
  action:
    alert:
      alert_fields:
        object|raw: $event.getClient_id()
      event_fields:
      - client_id
      - organization_group
      - source_name
      - log_name
      - signature_id
      - target_commandline
      - suser
      - hostname
      - user_name
      - customer_group
      - computer_name
      - target_process_path
      - source_process_path
      - source_commandline
severity: medium
version: 1
```
- Đầu vào của **-t** là đường dẫn của file chứa các json test trong đó mỗi dòng là một json test. Định dạng file rule là file **JSON**. Trong trường hợp file JSON rỗng hoặc file JSON không tồn tại thì công cụ sẽ sử dụng token SeaTable để lấy JSON.Ví dụ về một file testcase:
```json
{"@timestamp": "2023-10-12T04:41:16.385Z", "_id": "AYsiLi1_rl9GVbJ1rZ7J", "agentId": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "client_id": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "computer_name": "shyn.vcs.com", "customer_group": "CYM_MASTER", "device_product": "sysmon", "device_vendor": "microsoft", "duser": "VCS\\Administrator", "event_id": "806f02e9-106b-469c-a6f8-6639bd94d454", "file_company": "Microsoft Corporation", "file_description": "Find String (QGREP) Utility", "file_name_original": "FINDSTR.EXE", "file_product": "Microsoft\u00ae Windows\u00ae Operating System", "filename": "FINDSTR.EXE", "hashes": "SHA1=C6F01014D0CDCE1D77FC8C2F79447C28D8B8C9AD,MD5=15B171EC73E7B71F4EBB4247E716271E,SHA256=2956F7BC863498DFCC868CE7DF4C9C131A4A5C17B065658456AFEF7566ACE1EE,IMPHASH=D7962312082AAB17974D6817E09E5D7A", "hostname": "shyn", "input_plugin": "beats", "ips": ["192.168.75.174"], "local_timestamp": 1697058662000, "log_name": "Microsoft-Windows-Sysmon/Operational", "log_parser": "windows_event", "log_source": "Microsoft-Windows-Sysmon", "message": "Process Create", "organization_group": "root", "process_id": 7472, "raw_json": "{\"input_plugin\":\"beats\",\"process_id\":7472,\"agentId\":\"E82BA822EA6106B30B3B86EACB035ACA9B1D654E\",\"keywords\":null,\"record_number\":101845697,\"event_data\":{\"Company\":\"Microsoft Corporation\",\"ParentImage\":\"C:\\\\Windows\\\\System32\\\\cmd.exe\",\"Description\":\"Find String (QGREP) Utility\",\"LogonGuid\":\"{9E40972F-67C0-6527-3753-090000000000}\",\"User\":\"VCS\\\\Administrator\",\"OriginalFileName\":\"FINDSTR.EXE\",\"IntegrityLevel\":\"High\",\"TerminalSessionId\":\"1\",\"ParentProcessId\":\"6956\",\"ParentUser\":\"VCS\\\\Administrator\",\"Product\":\"Microsoft\u00ae Windows\u00ae Operating System\",\"Image\":\"C:\\\\Windows\\\\System32\\\\findstr.exe\",\"ProcessGuid\":\"{9E40972F-71D6-6527-7E01-000000001F00}\",\"UtcTime\":\"2023-10-12 04:11:02.145\",\"CurrentDirectory\":\"C:\\\\Users\\\\Administrator\\\\Desktop\\\\sprint 26\\\\\",\"CommandLine\":\"findstr  /S /I cpassword \\\\\\\\vcs.com\\\\sysvol\\\\vcs.com\\\\policies\\\\*.xml\",\"Hashes\":\"SHA1=C6F01014D0CDCE1D77FC8C2F79447C28D8B8C9AD,MD5=15B171EC73E7B71F4EBB4247E716271E,SHA256=2956F7BC863498DFCC868CE7DF4C9C131A4A5C17B065658456AFEF7566ACE1EE,IMPHASH=D7962312082AAB17974D6817E09E5D7A\",\"FileVersion\":\"10.0.14393.0 (rs1_release.160715-1616)\",\"ProcessId\":\"6888\",\"ParentCommandLine\":\"cmd.exe  /c findstr /S /I cpassword \\\\\\\\vcs.com\\\\sysvol\\\\vcs.com\\\\policies\\\\*.xml\",\"ParentProcessGuid\":\"{9E40972F-71D6-6527-7D01-000000001F00}\",\"LogonId\":\"0x95337\",\"RuleName\":\"-\"},\"opcode\":\"Info\",\"type\":\"wineventlog\",\"hostname\":\"shyn\",\"thread_id\":8824,\"SubjectType\":\"User\",\"provider_guid\":\"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}\",\"@version\":\"1\",\"SubjectDomainName\":\"NT AUTHORITY\",\"source_name\":\"Microsoft-Windows-Sysmon\",\"tenant\":\"CYM_MASTER\",\"severity\":2,\"computer_name\":\"shyn.vcs.com\",\"level\":\"information\",\"log_name\":\"Microsoft-Windows-Sysmon/Operational\",\"kind\":\"event\",\"log_parser\":\"windows_event\",\"message\":\"Process Create:\\nRuleName: -\\nUtcTime: 2023-10-12 04:11:02.145\\nProcessGuid: {9E40972F-71D6-6527-7E01-000000001F00}\\nProcessId: 6888\\nImage: C:\\\\Windows\\\\System32\\\\findstr.exe\\nFileVersion: 10.0.14393.0 (rs1_release.160715-1616)\\nDescription: Find String (QGREP) Utility\\nProduct: Microsoft\u00ae Windows\u00ae Operating System\\nCompany: Microsoft Corporation\\nOriginalFileName: FINDSTR.EXE\\nCommandLine: findstr  /S /I cpassword \\\\\\\\vcs.com\\\\sysvol\\\\vcs.com\\\\policies\\\\*.xml\\nCurrentDirectory: C:\\\\Users\\\\Administrator\\\\Desktop\\\\sprint 26\\\\\\nUser: VCS\\\\Administrator\\nLogonGuid: {9E40972F-67C0-6527-3753-090000000000}\\nLogonId: 0x95337\\nTerminalSessionId: 1\\nIntegrityLevel: High\\nHashes: SHA1=C6F01014D0CDCE1D77FC8C2F79447C28D8B8C9AD,MD5=15B171EC73E7B71F4EBB4247E716271E,SHA256=2956F7BC863498DFCC868CE7DF4C9C131A4A5C17B065658456AFEF7566ACE1EE,IMPHASH=D7962312082AAB17974D6817E09E5D7A\\nParentProcessGuid: {9E40972F-71D6-6527-7D01-000000001F00}\\nParentProcessId: 6956\\nParentImage: C:\\\\Windows\\\\System32\\\\cmd.exe\\nParentCommandLine: cmd.exe  /c findstr /S /I cpassword \\\\\\\\vcs.com\\\\sysvol\\\\vcs.com\\\\policies\\\\*.xml\\nParentUser: VCS\\\\Administrator\",\"server_id\":\"E82BA822EA6106B30B3B86EACB035ACA9B1D654E\",\"ips\":[\"192.168.75.174\"],\"SubjectUserName\":\"SYSTEM\",\"@timestamp\":\"2023-10-12T11:11:02.146Z\",\"event_id\":1,\"task\":\"Process Create (rule: ProcessCreate)\",\"customer_group\":\"CYM_MASTER\",\"local_timestamp\":1697083862146,\"SubjectUserSid\":\"S-1-5-18\"}", "rule_name": "-", "server_id": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "severity": 2, "signature_id": "1", "source_commandline": "cmd.exe  /c findstr /S /I cpassword \\\\vcs.com\\sysvol\\vcs.com\\policies\\*.xml", "source_log": "ad-beat", "source_name": "Microsoft-Windows-Sysmon", "source_process_guid": "{9E40972F-71D6-6527-7D01-000000001F00}", "source_process_path": "C:\\Windows\\System32\\cmd.exe", "source_user_name": "VCS\\Administrator", "sub_category": "Process Create (rule: ProcessCreate)", "suser": "SYSTEM", "target_commandline": "findstr  /S /I cpassword \\\\vcs.com\\sysvol\\vcs.com\\policies\\*.xml", "target_process_file_directory": "C:\\Users\\Administrator\\Desktop\\sprint 26\\", "target_process_file_version": "10.0.14393.0 (rs1_release.160715-1616)", "target_process_guid": "{9E40972F-71D6-6527-7E01-000000001F00}", "target_process_id": "6956", "target_process_integrity_level": "High", "target_process_path": "C:\\Windows\\System32\\findstr.exe", "target_user_logon_guid": "{9E40972F-67C0-6527-3753-090000000000}", "target_user_session_id": "1", "tenant": "CYM_MASTER", "timestamp": 1697085676385, "type": "wineventlog", "user_domain": "NT AUTHORITY", "user_reporter_type": "User", "user_sid": "S-1-5-18"}
{"@timestamp": "2023-10-19T03:12:23.259Z", "_id": "AYtF6PbMrl9GVbJ1r5MR", "agentId": "52BF43CA65494E7C8437D818CE09C1E4F9604DE9", "client_id": "52BF43CA65494E7C8437D818CE09C1E4F9604DE9", "computer_name": "WIN-KI7R2LED6LH.vcs.com", "customer_group": "CYM_MASTER", "device_product": "powershell", "device_vendor": "microsoft", "event_creation_time": 1697685072982, "event_id": "c25d660f-413f-4961-92a6-466ee4c5d7d2", "file_path": " ", "hostname": "WIN-KI7R2LED6LH", "input_plugin": "beats", "ips": ["192.168.131.128"], "local_timestamp": 1697685072982, "log_name": "Microsoft-Windows-PowerShell/Operational", "log_parser": "windows_event", "log_source": "Microsoft-Windows-PowerShell", "message": "Script Block Logging", "organization_group": "root", "powershell_message_number": "1", "powershell_parameter_bindling": "1", "powershell_scriptblock_id": "8570d166-bd6f-4bc2-b8c5-0312ed94c9e1", "powershell_scriptblock_text": "New-InboxRule \"CheckActionRequired\" -MyNameInToBox $true -FlaggedForAction Any -MarkImportance \"High\"", "process_id": 18812, "raw_json": "{\"input_plugin\":\"beats\",\"process_id\":18812,\"agentId\":\"52BF43CA65494E7C8437D818CE09C1E4F9604DE9\",\"keywords\":null,\"record_number\":49050,\"event_data\":{\"ScriptBlockText\":\"New-InboxRule \\\"CheckActionRequired\\\" -MyNameInToBox $true -FlaggedForAction Any -MarkImportance \\\"High\\\"\",\"ScriptBlockId\":\"8570d166-bd6f-4bc2-b8c5-0312ed94c9e1\",\"MessageNumber\":\"1\",\"MessageTotal\":\"1\"},\"opcode\":\"On create calls\",\"type\":\"wineventlog\",\"hostname\":\"WIN-KI7R2LED6LH\",\"thread_id\":12128,\"SubjectType\":\"User\",\"provider_guid\":\"{a0c1853b-5c40-4b15-8766-3cf1c58f985a}\",\"@version\":\"1\",\"SubjectDomainName\":\"VCS\",\"source_name\":\"Microsoft-Windows-PowerShell\",\"tenant\":\"CYM_MASTER\",\"severity\":null,\"computer_name\":\"WIN-KI7R2LED6LH.vcs.com\",\"level\":\"verbose\",\"log_name\":\"Microsoft-Windows-PowerShell/Operational\",\"kind\":\"event\",\"log_parser\":\"windows_event\",\"message\":\"Creating Scriptblock text (1 of 1):\\nNew-InboxRule \\\"CheckActionRequired\\\" -MyNameInToBox $true -FlaggedForAction Any -MarkImportance \\\"High\\\"\\n\\nScriptBlock ID: 8570d166-bd6f-4bc2-b8c5-0312ed94c9e1\\nPath: \",\"server_id\":\"52BF43CA65494E7C8437D818CE09C1E4F9604DE9\",\"ips\":[\"192.168.131.128\"],\"SubjectUserName\":\"Administrator\",\"@timestamp\":\"2023-10-19T10:11:12.982Z\",\"event_id\":4104,\"task\":\"Execute a Remote Command\",\"customer_group\":\"CYM_MASTER\",\"local_timestamp\":1697685072982,\"SubjectUserSid\":\"S-1-5-21-1480948839-1881322882-587910711-500\"}", "server_id": "52BF43CA65494E7C8437D818CE09C1E4F9604DE9", "severity": null, "signature_id": "4104", "source_log": "ad-beat", "source_name": "Microsoft-Windows-PowerShell", "sub_category": "Execute a Remote Command", "suser": "Administrator", "target_commandline": "New-InboxRule \"CheckActionRequired\" -MyNameInToBox $true -FlaggedForAction Any -MarkImportance \"High\"", "tenant": "CYM_MASTER", "timestamp": 1697685143259, "type": "wineventlog", "user_domain": "VCS", "user_reporter_type": "User", "user_sid": "S-1-5-21-1480948839-1881322882-587910711-500"}
{"@timestamp": "2023-10-12T03:37:45.601Z", "_id": "AYsh9lSqrl9GVbJ1ntM8", "agentId": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "client_id": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "computer_name": "shyn.vcs.com", "customer_group": "CYM_MASTER", "device_product": "powershell", "device_vendor": "microsoft", "event_creation_time": 1697081952913, "event_id": "d69d820b-bc02-4c6e-9b62-bce71c4eaae4", "file_path": " C:\\Users\\Administrator\\Desktop\\sprint 26\\RemoteCertTrust.ps1", "hostname": "shyn", "input_plugin": "beats", "ips": ["192.168.75.174"], "local_timestamp": 1697081952913, "log_name": "Microsoft-Windows-PowerShell/Operational", "log_parser": "windows_event", "log_source": "Microsoft-Windows-PowerShell", "message": "Script Block Logging", "organization_group": "root", "powershell_message_number": "1", "powershell_parameter_bindling": "1", "powershell_scriptblock_id": "bfae6c37-e823-466d-899d-cd5daef1b199", "powershell_scriptblock_text": "# Original https://gist.github.com/mattifestation/429008d961bb719d5bd5ce262557bdbf\n# Referenced blog: https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec\n\n$CertThumbprint = '1F3D38F280635F275BE92B87CF83E40E40458400'\n$EncodedCertBlob = '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'\n\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName CreateKey -Arguments @{\n    hDefKey = [UInt32] 2147483650 # HKLM\n    sSubKeyName = \"SOFTWARE\\Microsoft\\SystemCertificates\\ROOT\\Certificates\\$CertThumbprint\"\n}\n\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName SetBinaryValue -Arguments @{\n    hDefKey = [UInt32] 2147483650 # HKLM\n    sSubKeyName = \"SOFTWARE\\Microsoft\\SystemCertificates\\ROOT\\Certificates\\$CertThumbprint\"\n    sValueName = 'Blob'\n    uValue = [Convert]::FromBase64String($EncodedCertBlob)\n}", "process_id": 8460, "raw_json": "{\"input_plugin\":\"beats\",\"process_id\":8460,\"agentId\":\"E82BA822EA6106B30B3B86EACB035ACA9B1D654E\",\"keywords\":null,\"record_number\":24347,\"event_data\":{\"Path\":\"C:\\\\Users\\\\Administrator\\\\Desktop\\\\sprint 26\\\\RemoteCertTrust.ps1\",\"ScriptBlockText\":\"# Original https://gist.github.com/mattifestation/429008d961bb719d5bd5ce262557bdbf\\n# Referenced blog: https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec\\n\\n$CertThumbprint = '1F3D38F280635F275BE92B87CF83E40E40458400'\\n$EncodedCertBlob = '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'\\n\\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName CreateKey -Arguments @{\\n    hDefKey = [UInt32] 2147483650 # HKLM\\n    sSubKeyName = \\\"SOFTWARE\\\\Microsoft\\\\SystemCertificates\\\\ROOT\\\\Certificates\\\\$CertThumbprint\\\"\\n}\\n\\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName SetBinaryValue -Arguments @{\\n    hDefKey = [UInt32] 2147483650 # HKLM\\n    sSubKeyName = \\\"SOFTWARE\\\\Microsoft\\\\SystemCertificates\\\\ROOT\\\\Certificates\\\\$CertThumbprint\\\"\\n    sValueName = 'Blob'\\n    uValue = [Convert]::FromBase64String($EncodedCertBlob)\\n}\",\"ScriptBlockId\":\"bfae6c37-e823-466d-899d-cd5daef1b199\",\"MessageNumber\":\"1\",\"MessageTotal\":\"1\"},\"opcode\":\"On create calls\",\"type\":\"wineventlog\",\"hostname\":\"shyn\",\"thread_id\":8200,\"SubjectType\":\"User\",\"provider_guid\":\"{A0C1853B-5C40-4B15-8766-3CF1C58F985A}\",\"@version\":\"1\",\"SubjectDomainName\":\"VCS\",\"source_name\":\"Microsoft-Windows-PowerShell\",\"tenant\":\"CYM_MASTER\",\"severity\":null,\"computer_name\":\"shyn.vcs.com\",\"level\":\"verbose\",\"log_name\":\"Microsoft-Windows-PowerShell/Operational\",\"kind\":\"event\",\"log_parser\":\"windows_event\",\"message\":\"Creating Scriptblock text (1 of 1):\\n# Original https://gist.github.com/mattifestation/429008d961bb719d5bd5ce262557bdbf\\n# Referenced blog: https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec\\n\\n$CertThumbprint = '1F3D38F280635F275BE92B87CF83E40E40458400'\\n$EncodedCertBlob = 'BAAAAAEAAAAQAAAAgaT+C9ETBIfHkH5Zi2eoqw8AAAABAAAAIAAAAK7pIm4Ori+vdX436CAjk55T8gJEI7WBW1muIpb8dcC8FAAAAAEAAAAUAAAAAIZxjuuFqSJSqIzGDU9d5gKzHTAZAAAAAQAAABAAAADSxnNDC24NyPBSKJlFvtVeAwAAAAEAAAAUAAAAHz048oBjXydb6SuHz4PkDkBFhABcAAAAAQAAAAQAAAAAEAAAWQAAAAEAAAAWAAAAUgBTAEEALwBTAEgAQQAyADUANgAAACAAAAABAAAA3wUAADCCBdswggPDoAMCAQICEFJ2FzbupEWBQkU+LXP6ibIwDQYJKoZIhvcNAQELBQAwgYgxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYDVQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQgQ29ycG9yYXRpb24xMjAwBgNVBAMTKU1pY3Jvc29mdCBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAyMDEwMB4XDTE3MTIwMTIxNTUxNFoXDTQyMTIwMTA1MDYzN1owgYgxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYDVQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQgQ29ycG9yYXRpb24xMjAwBgNVBAMTKU1pY3Jvc29mdCBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAyMDEwMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAzSRYTzEnnwmvABZcLTj5H+xw1ulaHN2DJGwwKt77hrM8BcsJ/AdVY7EAf0QGqvV94QuDf5ENxihl59E6WMT5O5SRHcCQweVs0PHMhlw3qbEx7iiUr7HusyUiOA6Mj5yzKd7qtyxSUko92jj5SNZDcpAoniYyM4gKw8rdJiTm5ow4/03MDqoDDgG3LyFa8F6muKzjH6CeuKrlecazu96at4dH1+7kyJvfr7HuQn3phsKezUFVV76zASfmLndLdQx5Vj67sPs9eU9LLiGYoZy0OvE44DZ4I7XWOaqjNW8mXxwcACOpDXNrijEVlEFBG3ScNi7G/JMUy5kPX3yYZEv8h7lIY7QxoWkH/aZIXOoMrrDN00ngvL87J9l8bLwczwue28LbtXK7hjP7bq1dEWeCfq/tGJcQc3XjxfwUAI7un8+L63UXpemdJjeGLsLUpuR3qYMJA2nwnyOQh544WdOqKQhPyYX20qixvWujsm6fvXRS251rOx5xC/FHI37reBk90+6afauj5XQsgl3R7MZ2PVByoZHd70kHz0EhEszrzLnNn0EhhVOVFccpRh8jjSm5+a5rn4c3EdVs2oG2PmoO1fNJDZjXIVh1UVjlxY7NdP265s8NaSzLg5jA0URUstNWW7Kmeo0ag+Ts2tyd4ZthdRD6YioxboiAyPlhMRZ0npkCAwEAAaM/MD0wCwYDVR0PBAQDAgGGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFACGcY7rhakiUqiMxg1PXeYCsx0wMA0GCSqGSIb3DQEBCwUAA4ICAQAcvwFTSimkYCGQJ+loQR159m/KepR5VlbtE8dvMqsF9/Hghpy0TCw/v/Gmkn95Iw57aHvQshy7onIYJNDIWq0p792aiR0UhCyfjLX6Y660+RVWqTIsjdqDPqS/mpjMshWhB4IGtTxdQSQqn4Ow3k94gVxE8eG7NnJ1vh86YzbSLv36QVVxeFVQsZQqUCDrOkJgPNhkWcLEHI3tDwbGzx3eQjhRCx47fZSln0P4P5kZoRhO1zxBuxe37HakBEpspONrhe9/JEPrMbJIK5r10TwCYvntGNsdwXRdaC/Wigz/T6NUbU5LJiL/00mIMSmpu4HdaaxKXHTL+9gJWqHkd4+ymtnE0qTOb9woI7OvQCC/eiEsCEGHsClgB2jm/W8SIJS/bVO9Fk6fp7m6AYtFSa06FsuJ2J8ScRztFvS/KXyvupstiWTWQAYqt4c2aRvq9s8k/lg4V5glcYVdMs3fPG1z0QINJIWJOwU8Z175eDXPWXYn9UvmxmNLrkzqR3ouNmrMhk19mQLLkzLsf3VdErjJT4P6pMet39hOgLpNtL5qviZp7Dj9pEHHB3gIYss4migxbKGp6XJ1rs/mSKQbkpPYS8V0mDAO7TlpS1fZ5VPKTWj4XjomIJn6ocAchRok72Z7wMnSZ3y1hZtrsBieWFXBSyyFneVcmfswoFIbaoTn8A=='\\n\\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName CreateKey -Arguments @{\\n    hDefKey = [UInt32] 2147483650 # HKLM\\n    sSubKeyName = \\\"SOFTWARE\\\\Microsoft\\\\SystemCertificates\\\\ROOT\\\\Certificates\\\\$CertThumbprint\\\"\\n}\\n\\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName SetBinaryValue -Arguments @{\\n    hDefKey = [UInt32] 2147483650 # HKLM\\n    sSubKeyName = \\\"SOFTWARE\\\\Microsoft\\\\SystemCertificates\\\\ROOT\\\\Certificates\\\\$CertThumbprint\\\"\\n    sValueName = 'Blob'\\n    uValue = [Convert]::FromBase64String($EncodedCertBlob)\\n}\\n\\nScriptBlock ID: bfae6c37-e823-466d-899d-cd5daef1b199\\nPath: C:\\\\Users\\\\Administrator\\\\Desktop\\\\sprint 26\\\\RemoteCertTrust.ps1\",\"server_id\":\"E82BA822EA6106B30B3B86EACB035ACA9B1D654E\",\"ips\":[\"192.168.75.174\"],\"SubjectUserName\":\"Administrator\",\"@timestamp\":\"2023-10-12T10:39:12.913Z\",\"event_id\":4104,\"task\":\"Execute a Remote Command\",\"customer_group\":\"CYM_MASTER\",\"local_timestamp\":1697081952913,\"SubjectUserSid\":\"S-1-5-21-437558025-911198978-1688927390-500\"}", "server_id": "E82BA822EA6106B30B3B86EACB035ACA9B1D654E", "severity": null, "signature_id": "4104", "source_log": "ad-beat", "source_name": "Microsoft-Windows-PowerShell", "sub_category": "Execute a Remote Command", "suser": "Administrator", "target_commandline": "# Original https://gist.github.com/mattifestation/429008d961bb719d5bd5ce262557bdbf\n# Referenced blog: https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec\n\n$CertThumbprint = '1F3D38F280635F275BE92B87CF83E40E40458400'\n$EncodedCertBlob = 'BAAAAAEAAAAQAAAAgaT+C9ETBIfHkH5Zi2eoqw8AAAABAAAAIAAAAK7pIm4Ori+vdX436CAjk55T8gJEI7WBW1muIpb8dcC8FAAAAAEAAAAUAAAAAIZxjuuFqSJSqIzGDU9d5gKzHTAZAAAAAQAAABAAAADSxnNDC24NyPBSKJlFvtVeAwAAAAEAAAAUAAAAHz048oBjXydb6SuHz4PkDkBFhABcAAAAAQAAAAQAAAAAEAAAWQAAAAEAAAAWAAAAUgBTAEEALwBTAEgAQQAyADUANgAAACAAAAABAAAA3wUAADCCBdswggPDoAMCAQICEFJ2FzbupEWBQkU+LXP6ibIwDQYJKoZIhvcNAQELBQAwgYgxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYDVQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQgQ29ycG9yYXRpb24xMjAwBgNVBAMTKU1pY3Jvc29mdCBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAyMDEwMB4XDTE3MTIwMTIxNTUxNFoXDTQyMTIwMTA1MDYzN1owgYgxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpXYXNoaW5ndG9uMRAwDgYDVQQHEwdSZWRtb25kMR4wHAYDVQQKExVNaWNyb3NvZnQgQ29ycG9yYXRpb24xMjAwBgNVBAMTKU1pY3Jvc29mdCBSb290IENlcnRpZmljYXRlIEF1dGhvcml0eSAyMDEwMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAzSRYTzEnnwmvABZcLTj5H+xw1ulaHN2DJGwwKt77hrM8BcsJ/AdVY7EAf0QGqvV94QuDf5ENxihl59E6WMT5O5SRHcCQweVs0PHMhlw3qbEx7iiUr7HusyUiOA6Mj5yzKd7qtyxSUko92jj5SNZDcpAoniYyM4gKw8rdJiTm5ow4/03MDqoDDgG3LyFa8F6muKzjH6CeuKrlecazu96at4dH1+7kyJvfr7HuQn3phsKezUFVV76zASfmLndLdQx5Vj67sPs9eU9LLiGYoZy0OvE44DZ4I7XWOaqjNW8mXxwcACOpDXNrijEVlEFBG3ScNi7G/JMUy5kPX3yYZEv8h7lIY7QxoWkH/aZIXOoMrrDN00ngvL87J9l8bLwczwue28LbtXK7hjP7bq1dEWeCfq/tGJcQc3XjxfwUAI7un8+L63UXpemdJjeGLsLUpuR3qYMJA2nwnyOQh544WdOqKQhPyYX20qixvWujsm6fvXRS251rOx5xC/FHI37reBk90+6afauj5XQsgl3R7MZ2PVByoZHd70kHz0EhEszrzLnNn0EhhVOVFccpRh8jjSm5+a5rn4c3EdVs2oG2PmoO1fNJDZjXIVh1UVjlxY7NdP265s8NaSzLg5jA0URUstNWW7Kmeo0ag+Ts2tyd4ZthdRD6YioxboiAyPlhMRZ0npkCAwEAAaM/MD0wCwYDVR0PBAQDAgGGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFACGcY7rhakiUqiMxg1PXeYCsx0wMA0GCSqGSIb3DQEBCwUAA4ICAQAcvwFTSimkYCGQJ+loQR159m/KepR5VlbtE8dvMqsF9/Hghpy0TCw/v/Gmkn95Iw57aHvQshy7onIYJNDIWq0p792aiR0UhCyfjLX6Y660+RVWqTIsjdqDPqS/mpjMshWhB4IGtTxdQSQqn4Ow3k94gVxE8eG7NnJ1vh86YzbSLv36QVVxeFVQsZQqUCDrOkJgPNhkWcLEHI3tDwbGzx3eQjhRCx47fZSln0P4P5kZoRhO1zxBuxe37HakBEpspONrhe9/JEPrMbJIK5r10TwCYvntGNsdwXRdaC/Wigz/T6NUbU5LJiL/00mIMSmpu4HdaaxKXHTL+9gJWqHkd4+ymtnE0qTOb9woI7OvQCC/eiEsCEGHsClgB2jm/W8SIJS/bVO9Fk6fp7m6AYtFSa06FsuJ2J8ScRztFvS/KXyvupstiWTWQAYqt4c2aRvq9s8k/lg4V5glcYVdMs3fPG1z0QINJIWJOwU8Z175eDXPWXYn9UvmxmNLrkzqR3ouNmrMhk19mQLLkzLsf3VdErjJT4P6pMet39hOgLpNtL5qviZp7Dj9pEHHB3gIYss4migxbKGp6XJ1rs/mSKQbkpPYS8V0mDAO7TlpS1fZ5VPKTWj4XjomIJn6ocAchRok72Z7wMnSZ3y1hZtrsBieWFXBSyyFneVcmfswoFIbaoTn8A=='\n\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName CreateKey -Arguments @{\n    hDefKey = [UInt32] 2147483650 # HKLM\n    sSubKeyName = \"SOFTWARE\\Microsoft\\SystemCertificates\\ROOT\\Certificates\\$CertThumbprint\"\n}\n\nInvoke-CimMethod -Namespace root/default -ClassName StdRegProv -MethodName SetBinaryValue -Arguments @{\n    hDefKey = [UInt32] 2147483650 # HKLM\n    sSubKeyName = \"SOFTWARE\\Microsoft\\SystemCertificates\\ROOT\\Certificates\\$CertThumbprint\"\n    sValueName = 'Blob'\n    uValue = [Convert]::FromBase64String($EncodedCertBlob)\n}", "tenant": "CYM_MASTER", "timestamp": 1697081865601, "type": "wineventlog", "user_domain": "VCS", "user_reporter_type": "User", "user_sid": "S-1-5-21-437558025-911198978-1688927390-500"}
```
### Hướng dẫn đọc kết quả test
- Một rule sẽ có một trạng thái chính **(status)** và thông báo **(message)** đi kèm trạng thái đó:
  - **[Info]**: Rule đảm bảo pass các testcase. Xảy ra khi không có message con **[Warning]** và không có message con **[Error]**.
  - **[Warning]**: Rule cần được review trước khi bàn giao. Xảy ra khi có ít nhất một message con **[Warning]** và không có message con **[Error]**.
  - **[Error]**: Rule vi phạm checklist. Xảy ra khi có ít nhất một message con **[Error]**
- Các check list bao gồm:
  - Kiểm tra format rule hợp lệ. Nếu vi phạm check list có thể sinh ra một trong các message sau:
    - **[Warning] Unknown format rule or missing logsource**: format rule chưa được tạo hoặc thiếu trường logsource
    - **[Error] Missing field for {Format rule}: {'field_1', 'field_2', ..., 'field_n'}**: Rule thuộc một trong các [Format rule siem](../Rule Offline/format_rule/siem) hoặc [Format rule edr](../Rule Offline/format_rule/edr) tuy nhiên các thiếu các trường trong **event_fields** và **alert_fields**
  - Kiểm tra thông tin về mitre ATT&CK. Nếu vi phạm check list có thể sinh ra message sau:
    - **[Error] Missing Mitre ATT&CK metadata: [list_field]**: trong đó list_field cần thiết gồm **technique, tactic, datasource**
    - Kiểm tra thông tin thông thường của rule. Nếu vi phạm check list có thể sinh ra message sau:
    - **[Warning] Rule not in developer phase status: [status]**: Nếu **status** của rule khác **development** sẽ cảnh báo cho biết rằng đây thuộc dạng rule đã lên alpha hoặc maintain.
    - **[Warning] Rule severity need to be reviewed before submit: [SEVERITY]**: Nếu severity của rule khác **MEDIUM**
    - **[Error] Unknown Sprint of rule**: Thiếu tag Sprint
    - **[Error] Missing VCS_Content tags**: Thiếu tag VCS_Content/VCS_Content_Offline
  - Kiểm tra cảnh báo trùng và alert. Nếu rule chỉ bị trùng cảnh báo với các rule không thuộc Content TI thì message chỉ ở mức **[Warning]** còn lại là **[Error]** (Chỉ tính các cảnh báo trùng có severity từ MEDIUM trở lên):
    - **[Warning\Error] Duplicate multiple rule Content [SOC\TI] + List rule_name**
    - **[Error] Alert not found on portal!**: Rule không lên alert
    

